<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Водяна Агонія 3.7 - Шлях Додому</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&display=swap');
        :root { --main-red: #ff4848; --dark-red: #a01c1c; --border-color: #0a203e; --text-light: #fff; --hp-color: #32cd32; --text-dark: #2c1e14; --panel-border: #5a3d2b; --genshin-gold: #ece5d8; }
        
        body { font-family: 'Creepster', cursive; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-image: url('assets/background.jpg'); background-size: cover; background-position: center; color: var(--main-red); overflow: hidden; cursor: url('assets/anchor.png'), auto; }
        
        #gameContainer { width: 90vw; height: 80vh; max-width: 1000px; max-height: 700px; border: 5px solid var(--border-color); background-color: rgba(0, 0, 0, 0.4); position: relative; box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); transition: background-image 0.5s ease-in-out; overflow: hidden; }
        
        /* Backgrounds */
        .bg-kings-coast { background-image: url('assets/background.jpg'); }
        .bg-abyss { background-image: url('assets/abyss_bg.jpg'); }
        .bg-kraken { background-image: url('assets/kraken_bg.jpg'); }
        .bg-corals-despair { background-image: url('assets/corals_despair_bg.jpg'); }
        .bg-corals-acceptance { background-image: url('assets/corals_acceptance_bg.jpg'); }
        .bg-corals-abyss { background-image: url('assets/corals_abyss_bg.jpg'); }
        .bg-survival { background-color: #001a33; background-image: radial-gradient(#003366 1px, transparent 1px); background-size: 50px 50px; }

        /* Targets & Elements */
        .target { position: absolute; -webkit-user-drag: none; user-select: none; transition: transform 0.2s ease, opacity 0.3s ease; }
        .target.dying { opacity: 0; transform: scale(0.8) rotate(-25deg); }
        .finalboss { width: 250px; height: 250px; filter: drop-shadow(0 0 15px #ff4848); }
        .health-bar-container { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 80%; height: 15px; background-color: #555; border: 2px solid #000; border-radius: 5px; }
        .health-bar { width: 100%; height: 100%; background-color: var(--main-red); border-radius: 3px; transition: width 0.2s ease; }
        
        #playerSubmarine { position: absolute; width: 80px; height: 80px; z-index: 60; pointer-events: none; transition: opacity 0.3s ease; }
        #playerBoat { position: absolute; width: 60px; height: 100px; z-index: 70; pointer-events: none; transition: opacity 0.2s; }
        .projectile { position: absolute; width: 40px; height: 15px; z-index: 55; }
        .xp-item { position: absolute; width: 35px; height: 35px; z-index: 65; filter: drop-shadow(0 0 10px gold); }
        .invulnerable { opacity: 0.5; }

        /* UI */
        #uiContainer { position: absolute; top: 10px; right: 15px; display: flex; justify-content: flex-end; align-items: center; gap: 20px; font-size: 36px; text-shadow: 2px 2px 5px #000; z-index: 50; }
        #playerHealthDisplay { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: var(--hp-color); font-size: 36px; text-shadow: 2px 2px 5px #000; z-index: 50; }
        #inGameControls { position: absolute; bottom: 10px; left: 15px; z-index: 50; display: flex; gap: 10px; }
        #inGameControls button { font-family: 'Creepster', cursive; font-size: 20px; padding: 5px 15px; background-color: rgba(160, 28, 28, 0.7); color: var(--text-light); border: 2px solid var(--main-red); border-radius: 8px; cursor: pointer; }

        /* Screens */
        .messageScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; }
        .menu-panel { background-image: url('assets/ui_bg.png'); background-size: 100% 100%; padding: 30px 40px; border-radius: 15px; box-shadow: 0 0 25px rgba(0,0,0,0.5); max-width: 95%; color: var(--text-dark); display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        /* Map Navigation (The Arrows) */
        .map-nav-container { display: flex; align-items: center; justify-content: center; width: 100%; gap: 10px; }
        .map-viewport { width: 780px; overflow: hidden; padding: 20px 0; }
        .map-container { display: flex; gap: 20px; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); will-change: transform; }
        .nav-arrow { background: #d3bc8e; color: #3b3b3b; border: 3px solid #5a3d2b; font-size: 30px; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 10; font-family: serif; }
        .nav-arrow:disabled { opacity: 0.2; cursor: not-allowed; }
        .map-item { flex: 0 0 240px; background-color: rgba(240, 230, 209, 0.8); border: 3px solid var(--panel-border); padding: 20px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .map-item.locked { filter: grayscale(1); opacity: 0.7; }
        
        /* Notification */
        #notification-panel { position: absolute; top: 20px; right: 20px; width: 300px; background-color: rgba(0,0,0,0.85); border: 3px solid var(--main-red); border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px; z-index: 101; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        #notification-panel.show { opacity: 1; }
        #notification-portrait { width: 60px; height: 60px; border-radius: 50%; }
        #notification-text { font-size: 18px; color: var(--text-light); text-align: left; margin: 0; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <audio id="victoryMusicMap1" src="assets/map1_victory.mp3"></audio>

    <div id="gameContainer">
        <div id="uiContainer" class="hidden"> <div id="levelDisplay"></div> <div id="scoreDisplay"></div> <div id="timerDisplay"></div> </div>
        <div id="playerHealthDisplay" class="hidden"></div>
        <div id="inGameControls" class="hidden"> <button id="pauseButton"></button> <button id="returnToMenuButton"></button> </div>
        
        <div id="notification-panel" class="hidden"> <img id="notification-portrait" alt="portrait"> <p id="notification-text"></p> </div>

        <img id="playerSubmarine" class="hidden" src="assets/submarine.png" alt="Submarine">
        <img id="playerBoat" class="hidden" src="assets/boat.png" alt="Boat">

        <div id="mainMenuScreen" class="messageScreen">
            <div class="menu-panel main-menu">
                <h1 id="gameTitle"></h1>
                <button id="startButton"></button>
                <button id="mapButton"></button>
                <button id="mainMenuShopButton"></button>
                <button id="aboutButton"></button>
                <div class="button-row" id="lang-selector"> <button data-lang="uk" class="selected">Українська</button> <button data-lang="en">English</button> </div>
            </div>
        </div>

        <div id="mapScreen" class="messageScreen hidden">
            <div class="menu-panel" style="width: 950px;">
                <h1 id="mapTitle"></h1>
                <div class="map-nav-container">
                    <button class="nav-arrow" id="arrowLeft" onclick="moveMapScroll(-1)">&#10094;</button>
                    <div class="map-viewport">
                        <div class="map-container" id="mapList">
                            <div class="map-item" id="map-0"> <h2 id="map1Title"></h2> <button class="map-play-button" id="playMap1Button" onclick="selectMap(0)"></button> </div>
                            <div class="map-item locked" id="map-1"> <h2 id="map2Title"></h2> <p id="map2Locked"></p> <button class="map-play-button" id="playMap2Button" disabled onclick="selectMap(1)"></button> </div>
                            <div class="map-item locked" id="map-2"> <h2 id="map3Title"></h2> <p id="map3Locked"></p> <button class="map-play-button" id="playMap3Button" disabled onclick="selectMap(2)"></button> </div>
                            <div class="map-item locked" id="map-3"> <h2 id="map4Title">Шлях Додому</h2> <p id="map4Locked">(Здолай Русалку)</p> <button class="map-play-button" id="playMap4Button" disabled onclick="selectMap(3)">Грати</button> </div>
                        </div>
                    </div>
                    <button class="nav-arrow" id="arrowRight" onclick="moveMapScroll(1)">&#10095;</button>
                </div>
                <button id="mapBackButton"></button>
            </div>
        </div>

        <div id="setupScreen" class="messageScreen hidden"> <div class="menu-panel setup-menu"> <div id="character-container"> <img id="stanley-portrait" src="assets/stanley.png" alt="Пірат Стенлі"> <div id="stanley-dialogue"></div> </div> <div id="settings-container"> <p id="setupDiffLabel"></p> <div class="button-row" id="difficulty-selector"> <button data-difficulty="easy" id="diffBtnEasy" class="selected">Легко пливу</button> <button data-difficulty="normal" id="diffBtnNormal">Норм. зависаю</button> <button data-difficulty="jaws" id="diffBtnJaws">JAWS</button> </div> <button id="playButton"></button> <button id="backToMainButton"></button> </div> </div> </div>
        <div id="shopScreen" class="messageScreen hidden"> <div class="menu-panel"> <div id="shop-container"> <div id="shop-header"> <img id="mermaid-portrait" src="assets/mermaid.png" alt="Русалка"> <h1 id="shopTitle"></h1> </div> <p id="pearl-display"></p> <div id="shop-items"> <div class="shop-item"> <h3 id="shopWeaponTitle"></h3> <p id="shopWeaponDesc"></p> <button disabled></button> </div> <div class="shop-item"> <h3 id="shopScrollsTitle"></h3> <p id="shopScrollsDesc"></p> <div class="scroll-buttons"> <button id="readScroll1Button" disabled></button> <button id="readScroll2Button" disabled></button> </div> </div> <div class="shop-item"> <h3 id="shopLifeTitle"></h3> <p id="shopLifeDesc"></p> <button id="buyLifeButton" disabled></button> </div> </div> <button id="shopBackButton"></button> </div> </div> </div>
        <div id="scrollScreen" class="messageScreen hidden"> <div class="menu-panel"> <h1 id="scrollTitle"></h1> <p id="scroll-text"></p> <button id="scrollBackButton"></button> </div> </div>
        <div id="pauseScreen" class="messageScreen hidden"> <div class="menu-panel"> <h1 id="pauseTitle"></h1> <button id="resumeButton"></button> </div> </div>
        <div id="gameOverScreen" class="messageScreen hidden"> <div class="menu-panel"> <h1 id="gameOverTitle"></h1> <p id="gameOverMessage"></p> <button id="restartButton"></button> <button id="openShopButton" class="hidden"></button> </div> </div>
        <div id="aboutScreen" class="messageScreen hidden"> <div class="menu-panel"> <h1 id="aboutTitle"></h1> <div class="about-container"> <div class="bio-card"> <img src="assets/stanley.png"> <h3 id="stanley-name"></h3> <p id="stanley-bio"></p> </div> <div class="bio-card"> <img src="assets/mermaid.png"> <h3 id="mermaid-name"></h3> <p id="mermaid-bio"></p> </div> </div> <button id="aboutBackButton"></button> </div> </div>
    </div>

    <script>
        // --- DATA ---
        const KINGS_COAST = { name_uk: "Узбережжя Короля", type: "clicker", background: 'bg-kings-coast', levels: [{ enemies: ['shark1','shark2'] }, { finalBoss: 'megalodon' }] };
        const ABYSS_SHACKLES = { name_uk: "Окови Безодні", type: "clicker", background: 'bg-abyss', levels: [{ enemies: ['octopus'] }, { finalBoss: 'kraken' }] };
        const CREEPY_CORALS = { name_uk: "Моторошні Корали", type: "clicker", background: 'bg-corals-despair', levels: [{ enemies: ['moray_eel'] }, { finalBoss: 'evil_mermaid', isSub: true, background: 'bg-corals-abyss' }] };
        const SURVIVAL_MAP = { name_uk: "Шлях Додому", type: "survival", background: 'bg-survival', levels: [{ enemies: ['shark1'] }] };

        const gameConfig = {
            enemies: {
                shark1: { src: 'assets/shark_1.png', sizeClass: 'shark' },
                shark2: { src: 'assets/shark_2.png', sizeClass: 'shark' },
                octopus: { src: 'assets/octopus.png', sizeClass: 'octopus' },
                moray_eel: { src: 'assets/moray_eel.png', sizeClass: 'barracuda' },
                white_shark: { src: 'assets/white_shark.png', sizeClass: 'miniboss', hp: 20, points: 10, damage: 2 },
                megalodon: { src: 'assets/megalodon.png', sizeClass: 'finalboss', pattern: 'vertical', hp: { easy: 38, normal: 50, jaws: 100 }, damage: 5 },
                kraken: { src: 'assets/kraken.png', sizeClass: 'kraken', pattern: 'vertical', hp: { easy: 45, normal: 60, jaws: 120 }, damage: 5 },
                evil_mermaid: { src: 'assets/evil_mermaid.png', sizeClass: 'finalboss', pattern: 'wavy', hp: { easy: 50, normal: 70, jaws: 140 }, damage: 10 }
            },
            mapsData: [ KINGS_COAST, ABYSS_SHACKLES, CREEPY_CORALS, SURVIVAL_MAP ]
        };

        const translations = {
            uk: {
                map: "Карта Світу", map1: "Узбережжя Короля", map2: "Окови Безодні", map3: "Моторошні Корали", map2Locked: "(Здолай Мегалодона)", map3Locked: "(Здолай Кракена)", play: "Грати", back: "Назад",
                shop: "Забавульки Русалки", shopWeapon: "Зброя", shopWeaponDesc: "Нові гарпуни (скоро)", shopScrolls: "Свитки", shopScrollsDesc: "Древні історії", read: "Читати", shopLife: "Життя", shopLifeDesc: "+1 ❤️ (10 Перлин)", shopBuy: "Купити", pearl: "Перлин",
                scroll1Button: "Легенда про Кракена", scroll2Button: "Сцилла та Харибда",
                scroll1Text: "Глибоко, де сонце лише спогад, спить Він. Кракен...",
                scroll2Text: "Коли море було молодим, сестри Сцилла та Харибда пожирали зірки... Кажуть, злі русалки досі чують їхній шепіт.",
                gameTitle: "Водяна Агонія", startButton: "Старт", playButton: "В БІЙ!", diffEasy: "Легко", diffNormal: "Норм", diffJaws: "JAWS", 
                pause: "Пауза", resume: "Продовжити", mainMenu: "Меню", gameOver: "КІНЕЦЬ ГРИ", win: "ПЕРЕМОГА!", 
                megalodonWarning: "Це він! Мегалодон!", krakenWarning: "Кракен близько...",
                mermaidWarning: "Деякі мої сестри живуть за законами Сцилли та Харибди... Стережись!",
                aboutTitle: "Герої", aboutBackButton: "Назад", stanleyName: "Стенлі", stanleyBio: "Мисливець на акул.", mermaidName: "Русалка", mermaidBio: "Торговка артефактами."
            }
        };

        let gameState = { currentMap: 0, currentLevel: 0, score: 0, timeLeft: 120, playerHealth: 10, currentLang: 'uk', currentDifficulty: 'easy', isPaused: false, isSub: false, isSurv: false, invul: false, scrollPos: 0, intervals: [], activeTargets: [], activeProjectiles: [] };
        let playerData = { pearls: 0, m1: false, m2: false, m3: false };

        // --- CORE FUNCTIONS ---
        function savePlayerData() { localStorage.setItem('wateryAgonyData', JSON.stringify(playerData)); }
        function loadPlayerData() { const data = localStorage.getItem('wateryAgonyData'); if (data) playerData = JSON.parse(data); }

        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerData();
            attachEventListeners();
            updateUIText();
            showScreen('main');
        });

        function attachEventListeners() {
            document.getElementById('startButton').onclick = () => selectMap(0);
            document.getElementById('mapButton').onclick = openMapScreen;
            document.getElementById('mainMenuShopButton').onclick = openShop;
            document.getElementById('aboutButton').onclick = () => showScreen('about');
            document.getElementById('aboutBackButton').onclick = () => showScreen('main');
            document.getElementById('playButton').onclick = startGame;
            document.getElementById('backToMainButton').onclick = () => showScreen('main');
            document.getElementById('mapBackButton').onclick = () => showScreen('main');
            document.getElementById('restartButton').onclick = () => location.reload();
            document.getElementById('pauseButton').onclick = togglePause;
            document.getElementById('resumeButton').onclick = togglePause;
            document.getElementById('returnToMenuButton').onclick = () => location.reload();
            document.getElementById('openShopButton').onclick = openShop;
            document.getElementById('shopBackButton').onclick = () => showScreen('main');
            document.getElementById('readScroll1Button').onclick = () => displayScroll(1);
            document.getElementById('readScroll2Button').onclick = () => displayScroll(2);
            document.getElementById('scrollBackButton').onclick = () => showScreen('shop');
            document.getElementById('difficulty-selector').onclick = (e) => { if (e.target.tagName === 'BUTTON') {
                gameState.currentDifficulty = e.target.dataset.difficulty;
                document.querySelectorAll('#difficulty-selector button').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }};
        }

        function showScreen(name) {
            document.querySelectorAll('.messageScreen').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('#uiContainer, #inGameControls, #playerHealthDisplay').forEach(el => el.classList.add('hidden'));
            if(name !== 'none') document.getElementById(name + 'Screen').classList.remove('hidden');
        }

        function openMapScreen() {
            showScreen('map');
            document.getElementById('map-1').classList.toggle('locked', !playerData.m1);
            document.getElementById('playMap2Button').disabled = !playerData.m1;
            document.getElementById('map-2').classList.toggle('locked', !playerData.m2);
            document.getElementById('playMap3Button').disabled = !playerData.m2;
            document.getElementById('map-3').classList.toggle('locked', !playerData.m3);
            document.getElementById('playMap4Button').disabled = !playerData.m3;
            moveMapScroll(0);
        }

        function moveMapScroll(dir) {
            const container = document.getElementById('mapList');
            const cardWidth = 260; 
            gameState.scrollPos += dir * cardWidth;
            const maxScroll = cardWidth * (gameConfig.mapsData.length - 3);
            if(gameState.scrollPos < 0) gameState.scrollPos = 0;
            if(gameState.scrollPos > maxScroll) gameState.scrollPos = maxScroll;
            container.style.transform = `translateX(-${gameState.scrollPos}px)`;
            document.getElementById('arrowLeft').disabled = gameState.scrollPos <= 0;
            document.getElementById('arrowRight').disabled = gameState.scrollPos >= maxScroll;
        }

        function selectMap(idx) { gameState.currentMap = idx; showScreen('setup'); }

        function startGame() {
            showScreen('none');
            document.querySelectorAll('#uiContainer, #inGameControls, #playerHealthDisplay').forEach(el => el.classList.remove('hidden'));
            gameState.currentLevel = 0;
            
            const map = gameConfig.mapsData[gameState.currentMap];
            if(map.type === 'survival') {
                if(gameState.currentDifficulty === 'easy') gameState.playerHealth = 15;
                else if(gameState.currentDifficulty === 'normal') gameState.playerHealth = 10;
                else gameState.playerHealth = 5;
            } else {
                gameState.playerHealth = 10;
            }
            
            startLevel();
            if (!gameState.animationFrameId) gameLoop();
        }

        function startLevel() {
            const map = gameConfig.mapsData[gameState.currentMap];
            const level = map.levels[gameState.currentLevel];
            stopGameActivity(false);
            
            if (level.finalBoss) { triggerBossSequence(); return; }

            gameState.isSurv = map.type === 'survival';
            gameState.score = 0;
            gameState.timeLeft = 120;
            document.getElementById('gameContainer').className = level.background || map.background;
            updateGameUI();

            if(gameState.isSurv) {
                document.getElementById('playerBoat').classList.remove('hidden');
                document.getElementById('gameContainer').onmousemove = moveBoat;
                for(let i=0; i<6; i++) spawnEnemy(level.enemies[0]);
                spawnXP();
            } else {
                const diff = {easy:1200, normal:900, jaws:600}[gameState.currentDifficulty];
                gameState.intervals.push(setInterval(() => spawnEnemy(level.enemies[0]), diff));
                gameState.intervals.push(setInterval(updateTimer, 1000));
            }
        }

        function triggerBossSequence() {
            const boss = gameConfig.mapsData[gameState.currentMap].levels[gameState.currentLevel].finalBoss;
            const char = (boss === 'evil_mermaid') ? 'mermaid' : 'stanley';
            const msg = boss + 'Warning';
            showNotification(char, msg, startBossLevel);
        }

        function startBossLevel() {
            const level = gameConfig.mapsData[gameState.currentMap].levels[gameState.currentLevel];
            gameState.isSub = level.isSub || false;
            gameState.timeLeft = 999;
            document.getElementById('gameContainer').className = level.background;
            if(gameState.isSub) {
                document.getElementById('playerSubmarine').classList.remove('hidden');
                document.getElementById('gameContainer').onmousemove = moveSub;
                document.getElementById('gameContainer').onclick = shootTorpedo;
                document.getElementById('gameContainer').style.cursor = 'none';
            }
            spawnEnemy(level.finalBoss, true);
            updateGameUI();
        }

        function spawnEnemy(type, isBoss = false) {
            const data = gameConfig.enemies[type];
            const el = document.createElement('img');
            el.src = data.src;
            el.className = 'target ' + (data.sizeClass || '');
            const obj = { el, type, isBoss, x: Math.random()*800, y: Math.random()*500, dir: 1, speed: 2+Math.random()*2 };
            
            if(isBoss) {
                obj.hp = data.hp[gameState.currentDifficulty] || data.hp;
                obj.max = obj.hp;
                const bar = document.createElement('div'); bar.className='health-bar-container';
                const fill = document.createElement('div'); fill.className='health-bar';
                bar.appendChild(fill); el.appendChild(bar); obj.bar = fill;
            }

            if(!gameState.isSurv && !gameState.isSub) {
                el.onclick = () => damageEnemy(obj);
                obj.x = -150; obj.y = Math.random()*500;
            }

            document.getElementById('gameContainer').appendChild(el);
            gameState.activeTargets.push(obj);
        }

        function spawnXP() {
            const el = document.createElement('img');
            el.src = 'assets/xp_item.png'; el.className = 'xp-item';
            el.style.left = Math.random()*900+'px'; el.style.top = Math.random()*600+'px';
            document.getElementById('gameContainer').appendChild(el);
            gameState.activeProjectiles.push({el, type:'xp'});
        }

        function moveBoat(e) {
            const rect = document.getElementById('gameContainer').getBoundingClientRect();
            const b = document.getElementById('playerBoat');
            b.style.left = (e.clientX - rect.left - 30) + 'px';
            b.style.top = (e.clientY - rect.top - 50) + 'px';
        }

        function moveSub(e) {
            const rect = document.getElementById('gameContainer').getBoundingClientRect();
            const s = document.getElementById('playerSubmarine');
            s.style.left = (e.clientX - rect.left - 40) + 'px';
            s.style.top = (e.clientY - rect.top - 40) + 'px';
        }

        function shootTorpedo() {
            const s = document.getElementById('playerSubmarine').getBoundingClientRect();
            const c = document.getElementById('gameContainer').getBoundingClientRect();
            const t = document.createElement('img'); t.src = 'assets/torpedo.png'; t.className = 'projectile';
            let tx = s.left - c.left + 20; let ty = s.top - c.top;
            t.style.left = tx + 'px'; t.style.top = ty + 'px';
            document.getElementById('gameContainer').appendChild(t);
            gameState.activeProjectiles.push({el:t, x:tx, y:ty, type:'torpedo'});
        }

        function gameLoop() {
            if(!gameState.isPaused) {
                // Survival Movement
                if(gameState.isSurv) {
                    gameState.activeTargets.forEach(s => {
                        s.x += s.speed * s.dir; if(s.x > 900 || s.x < 0) s.dir *= -1;
                        s.el.style.left = s.x+'px'; s.el.style.top = s.y+'px';
                        if(!gameState.invul && checkColl(document.getElementById('playerBoat'), s.el)) takeDamage();
                    });
                    gameState.activeProjectiles.forEach((p, i) => {
                        if(p.type === 'xp' && checkColl(document.getElementById('playerBoat'), p.el)) {
                            p.el.remove(); gameState.activeProjectiles.splice(i,1);
                            gameState.score++; updateGameUI(); spawnXP();
                            if(gameState.score >= 20) endGame(true, "", true);
                        }
                    });
                }
                // Clicker Movement
                if(!gameState.isSurv && !gameState.isSub) {
                    gameState.activeTargets.forEach((s, i) => {
                        if(!s.isBoss) {
                            s.x += 3; s.el.style.left = s.x+'px'; s.el.style.top = s.y+'px';
                            if(s.x > 1050) { s.el.remove(); gameState.activeTargets.splice(i,1); takeDamage(); }
                        }
                    });
                }
                // Submarine Movement
                if(gameState.isSub) {
                    gameState.activeProjectiles.forEach((p, i) => {
                        if(p.type === 'torpedo') {
                            p.y -= 7; p.el.style.top = p.y+'px';
                            const boss = gameState.activeTargets.find(t => t.isBoss);
                            if(boss && checkColl(p.el, boss.el)) {
                                p.el.remove(); gameState.activeProjectiles.splice(i,1);
                                damageEnemy(boss);
                            }
                        }
                    });
                }
            }
            gameState.animationFrameId = requestAnimationFrame(gameLoop);
        }

        function damageEnemy(obj) {
            if(obj.isBoss) {
                obj.hp--; obj.bar.style.width = (obj.hp/obj.max)*100 + '%';
                if(obj.hp <= 0) endGame(true, "", true);
            } else {
                obj.el.classList.add('dying');
                setTimeout(() => obj.el.remove(), 300);
                gameState.activeTargets = gameState.activeTargets.filter(t => t !== obj);
                gameState.score += 5; updateGameUI();
                if(gameState.score >= GOAL_SCORE) { gameState.currentLevel++; startLevel(); }
            }
        }

        function takeDamage() {
            gameState.playerHealth--; updateGameUI();
            if(gameState.playerHealth <= 0) endGame(false);
            gameState.invul = true;
            const p = gameState.isSurv ? document.getElementById('playerBoat') : document.getElementById('playerSubmarine');
            if(p) p.classList.add('invulnerable');
            setTimeout(() => { gameState.invul = false; if(p) p.classList.remove('invulnerable'); }, 2000);
        }

        function checkColl(a, b) {
            const r1 = a.getBoundingClientRect(); const r2 = b.getBoundingClientRect();
            return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
        }

        function stopGameActivity(clear) {
            gameState.intervals.forEach(clearInterval); gameState.intervals = [];
            if(clear) {
                gameState.activeTargets.forEach(t => t.el.remove()); gameState.activeTargets = [];
                gameState.activeProjectiles.forEach(p => p.el.remove()); gameState.activeProjectiles = [];
                document.getElementById('playerBoat').classList.add('hidden');
                document.getElementById('playerSubmarine').classList.add('hidden');
                document.getElementById('gameContainer').style.cursor = `url('assets/anchor.png'), auto`;
            }
        }

        function endGame(win, msg, isFinal) {
            stopGameActivity(true);
            const T = translations[gameState.currentLang];
            if(isFinal) {
                if(gameState.currentMap === 0) playerData.m1 = true;
                if(gameState.currentMap === 1) playerData.m2 = true;
                if(gameState.currentMap === 2) playerData.m3 = true;
                playerData.pearls += 10; savePlayerData();
                document.getElementById('gameOverTitle').textContent = T.win;
                document.getElementById('openShopButton').classList.remove('hidden');
            } else {
                document.getElementById('gameOverTitle').textContent = T.gameOver;
            }
            showScreen('gameover');
        }

        function showNotification(char, key, cb) {
            notificationPortrait.src = `assets/${char}.png`;
            notificationText.textContent = translations[gameState.currentLang][key];
            notificationPanel.classList.add('show');
            setTimeout(() => { notificationPanel.classList.remove('show'); if(cb) cb(); }, 5000);
        }

        function updateUIText() {
            const T = translations[gameState.currentLang];
            for (const id in T) { const el = document.getElementById(id); if(el) el.textContent = T[id]; }
            document.getElementById('gameTitle').textContent = T.gameTitle;
            document.getElementById('startButton').textContent = T.startButton;
            document.getElementById('mapButton').textContent = T.map;
            document.getElementById('mainMenuShopButton').textContent = T.shop;
            document.getElementById('aboutButton').textContent = translations[gameState.currentLang].aboutTitle;
        }

        function updateGameUI() {
            const T = translations[gameState.currentLang];
            document.getElementById('playerHealthDisplay').textContent = '❤️ ' + gameState.playerHealth;
            document.getElementById('scoreDisplay').textContent = T.score + ': ' + gameState.score;
            document.getElementById('levelDisplay').textContent = gameConfig.mapsData[gameState.currentMap].name_uk;
            document.getElementById('timerDisplay').textContent = T.time + ': ' + gameState.timeLeft;
        }

        function togglePause() { 
            gameState.isPaused = !gameState.isPaused; 
            showScreen(gameState.isPaused ? 'pause' : 'none');
            if(!gameState.isPaused) document.querySelectorAll('#uiContainer, #inGameControls, #playerHealthDisplay').forEach(el => el.classList.remove('hidden'));
        }

        function openShop() { showScreen('shop'); document.getElementById('pearl-display').textContent = "Перлини: " + playerData.pearls; document.getElementById('readScroll1Button').disabled = !playerData.m1; document.getElementById('readScroll2Button').disabled = !playerData.m3; }
        function displayScroll(n) { showScreen('scroll'); document.getElementById('scroll-text').textContent = translations[gameState.currentLang]['scroll'+n+'Text']; }
        function updateTimer() { if(!gameState.isPaused) { gameState.timeLeft--; updateGameUI(); if(gameState.timeLeft<=0) endGame(false); }}
    </script>
</body>
</html>